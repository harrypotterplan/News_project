<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>{{ article.title }} - AI News Master</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* ì¶”ê°€ì ì¸ ìŠ¤íƒ€ì¼: ë³¸ë¬¸ ë‚´ìš©ì„ ë” ì½ê¸° í¸í•˜ê²Œ */
        .article-content {
            line-height: 1.8;
            font-size: 1.1em;
            margin-bottom: 2rem;
            white-space: pre-wrap; /* ë³¸ë¬¸ ë‚´ìš©ì˜ ì¤„ë°”ê¿ˆì„ ìœ ì§€ */
        }
        body {
            padding-bottom: 70px; /* í•˜ë‹¨ ë²„íŠ¼ ë° í‘¸í„° ê³µê°„ í™•ë³´ */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-3">{{ article.title }}</h1>
        <p class="text-muted">
            <strong>ì¹´í…Œê³ ë¦¬:</strong> {{ article.category | default('ë¯¸ë¶„ë¥˜') }} &nbsp;|&nbsp;
            <strong>ë°œí–‰ì¼:</strong> {{ article.published_at.strftime('%Y-%m-%d %H:%M') if article.published_at else 'ì•Œ ìˆ˜ ì—†ìŒ' }}
        </p>
        
        <p class="lead">{{ article.summary | default('ìš”ì•½ ì—†ìŒ') }}</p>
        
        <div class="article-content">
            <p>{{ article.full_content | default('ë³¸ë¬¸ ì—†ìŒ') }}</p>
        </div>

        <a href="{{ article.url }}" target="_blank" class="btn btn-secondary mt-3 mb-4">ì›ë¬¸ ë³´ê¸°</a>
        
        <div class="mt-3 mb-4 d-flex align-items-center">
            <span class="me-3">ì´ ê¸°ì‚¬ê°€ ìœ ìš©í–ˆë‚˜ìš”?</span>
            <button onclick="submitFeedback('like')" class="btn btn-success me-2">
                <i class="bi bi-hand-thumbs-up-fill"></i> ì¢‹ì•„ìš”
            </button>
            <button onclick="submitFeedback('dislike')" class="btn btn-danger me-2">
                <i class="bi bi-hand-thumbs-down-fill"></i> ì‹«ì–´ìš”
            </button>
            <button id="cancelFeedbackBtn" onclick="submitFeedback('cancel')" class="btn btn-outline-warning">
                í”¼ë“œë°± ì·¨ì†Œ
            </button>
        </div>
        
        <a href="{{ url_for('home') }}" class="btn btn-primary mt-3">í™ˆìœ¼ë¡œ</a>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <script>
        // --- read_time ë° scroll_depth ì¶”ì  ë¡œì§ ì‹œì‘ ---
        let startTime = Date.now(); // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        let maxScrollDepth = 0;     // ìµœëŒ€ ìŠ¤í¬ë¡¤ ê¹Šì´ (0.0 ~ 1.0)

        window.addEventListener('scroll', () => {
            // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì™€ ë¬¸ì„œ ë†’ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ìŠ¤í¬ë¡¤ ê¹Šì´ ì—…ë°ì´íŠ¸
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrollDepth = docHeight > 0 ? scrollTop / docHeight : 0; 
            maxScrollDepth = Math.max(maxScrollDepth, scrollDepth);
        });

        // ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ (ë¸Œë¼ìš°ì € íƒ­ ë‹«ê¸°, ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™ ë“±) ë¡œê·¸ ë°ì´í„° ì „ì†¡
        window.addEventListener('unload', () => {
            const readTime = Math.round((Date.now() - startTime) / 1000); // í˜ì´ì§€ ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
            
            // ì „ì†¡í•  ë°ì´í„° ê°ì²´ ìƒì„±
            const data = {
                article_id: {{ article.id }},
                action_type: 'read', // 'read' ì•¡ì…˜ ëª…ì‹œ
                read_time: readTime,
                scroll_depth: maxScrollDepth.toFixed(2) // ì†Œìˆ˜ì  ë‘ ìë¦¬ë¡œ ê³ ì •
            };

            // navigator.sendBeaconì„ ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
            // ì´ ë°©ì‹ì€ í˜ì´ì§€ê°€ ì™„ì „íˆ ì–¸ë¡œë“œë˜ê¸° ì „ì— ìš”ì²­ì´ ì·¨ì†Œë  ìœ„í—˜ì„ ì¤„ì—¬ì¤Œ
            // ì„œë²„ì—ì„œëŠ” request.get_data()ë¡œ raw JSON ë¬¸ìì—´ì„ ë°›ì•„ json.loads()ë¡œ íŒŒì‹±í•´ì•¼ í•¨
            navigator.sendBeacon('/log_action', JSON.stringify(data));
        });
        // --- read_time ë° scroll_depth ì¶”ì  ë¡œì§ ë ---


        // --- í”¼ë“œë°± ì œì¶œ ë¡œì§ ì‹œì‘ ---
        function submitFeedback(feedbackType) {
            fetch('/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }, // ì„œë²„ì— JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì „ì†¡ì„ì„ ì•Œë¦¼
                body: JSON.stringify({
                    article_id: {{ article.id }},
                    feedback_type: feedbackType
                })
            })
            .then(response => {
                if (!response.ok) {
                    // HTTP ìƒíƒœ ì½”ë“œê°€ 200ë²ˆëŒ€ê°€ ì•„ë‹ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // ì‘ë‹µ ë³¸ë¬¸ì„ JSONìœ¼ë¡œ íŒŒì‹±
            })
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    // í”¼ë“œë°± ì œì¶œ ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸ (ì˜ˆ: ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”)
                    updateFeedbackButtons(feedbackType); 
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error submitting feedback:', error);
                alert('í”¼ë“œë°± ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        // --- ì„ íƒ ì‚¬í•­: í”¼ë“œë°± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê³ ê¸‰ UX) ---
        // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”/ì‹«ì–´ìš”ë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ ë²„íŠ¼ì€ ë¹„í™œì„±í™”í•˜ê³ , ë‹¤ë¥¸ í”¼ë“œë°± ë²„íŠ¼ì„ í™œì„±í™”í•˜ëŠ” ë“±
        // UXë¥¼ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë¡œì§ì´ì•¼. ì‹¤ì œ êµ¬í˜„í•˜ë ¤ë©´ ë°±ì—”ë“œì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ í˜„ì¬ í”¼ë“œë°± ìƒíƒœë¥¼ 
        // ê°€ì ¸ì™€ì„œ í˜ì´ì§€ ë¡œë“œ ì‹œ ì ìš©í•˜ê³ , í”¼ë“œë°± ì œì¶œ í›„ì—ë„ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•´.
        function updateFeedbackButtons(currentFeedback) {
            const likeBtn = document.querySelector('.btn-success');
            const dislikeBtn = document.querySelector('.btn-danger');
            const cancelBtn = document.getElementById('cancelFeedbackBtn');

            // ëª¨ë“  ë²„íŠ¼ì„ ê¸°ë³¸ ìƒíƒœ(í™œì„±í™”)ë¡œ ì„¤ì •
            likeBtn.classList.remove('disabled');
            dislikeBtn.classList.remove('disabled');
            cancelBtn.classList.remove('disabled');

            // í˜„ì¬ í”¼ë“œë°± íƒ€ì…ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            if (currentFeedback === 'like') {
                likeBtn.classList.add('disabled'); // ì¢‹ì•„ìš” ë²„íŠ¼ ë¹„í™œì„±í™”
                likeBtn.textContent = 'ğŸ‘ ì¢‹ì•„ìš” (ì„ íƒë¨)'; // í…ìŠ¤íŠ¸ ë³€ê²½
            } else if (currentFeedback === 'dislike') {
                dislikeBtn.classList.add('disabled'); // ì‹«ì–´ìš” ë²„íŠ¼ ë¹„í™œì„±í™”
                dislikeBtn.textContent = 'ğŸ‘ ì‹«ì–´ìš” (ì„ íƒë¨)'; // í…ìŠ¤íŠ¸ ë³€ê²½
            } else if (currentFeedback === 'cancel') {
                // ì·¨ì†Œ í›„ì—ëŠ” ëª¨ë“  ë²„íŠ¼ í™œì„±í™”í•˜ê³  ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë˜ëŒë¦¼
                likeBtn.textContent = 'ì¢‹ì•„ìš”';
                dislikeBtn.textContent = 'ì‹«ì–´ìš”';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì‚¬ìš©ìì˜ í”¼ë“œë°± ìƒíƒœë¥¼ ê°€ì ¸ì™€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜ˆì‹œ)
        window.onload = function() {
            // ì´ ë¶€ë¶„ì€ ì‹¤ì œ ë°±ì—”ë“œ API (ì˜ˆ: /get_user_feedback_status/article_id)ê°€ í•„ìš”í•´.
            // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì´ ê¸°ì‚¬ì— ëŒ€í•´ ì–´ë–¤ í”¼ë“œë°±ì„ ë‚¨ê²¼ëŠ”ì§€ ê°€ì ¸ì™€ì„œ
            // updateFeedbackButtons í•¨ìˆ˜ì— ì „ë‹¬í•˜ë©´ ë¼.
            // ì˜ˆì‹œ:
            /*
            fetch(`/get_user_feedback_status/{{ article.id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.feedback_type) {
                        updateFeedbackButtons(data.feedback_type);
                    } else {
                        updateFeedbackButtons(null); // í”¼ë“œë°± ì—†ìŒ
                    }
                })
                .catch(error => console.error('Error fetching feedback status:', error));
            */
            // ì„ì‹œë¡œ ì´ˆê¸°í™” (ì‹¤ì œ ë°°í¬ ì‹œ ìœ„ fetch ë¡œì§ìœ¼ë¡œ ëŒ€ì²´)
            updateFeedbackButtons(null);
        };
        // --- í”¼ë“œë°± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ë ---
    </script>
    </body>
</html>